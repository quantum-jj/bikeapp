<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Bikes">
<meta name="theme-color" content="#000000">
<title>Bike Checker</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQmlrZSBDaGVja2VyIiwic2hvcnRfbmFtZSI6IkJpa2VzIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwMDAwMDAiLCJ0aGVtZV9jb2xvciI6IiMwMDAwMDAifQ==">
<style>
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  :root {
    --bg: #000000;
    --bg-card: #1c1c1e;
    --bg-card-hover: #2c2c2e;
    --text-primary: #ffffff;
    --text-secondary: #8e8e93;
    --text-tertiary: #636366;
    --separator: rgba(84,84,88,0.35);
    --blue: #0a84ff;
    --green: #30d158;
    --yellow: #ffd60a;
    --red: #ff453a;
    --orange: #ff9f0a;
    --safe-top: env(safe-area-inset-top, 20px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --radius: 13px;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text-primary);
    min-height: 100dvh;
    -webkit-font-smoothing: antialiased;
    overscroll-behavior: none;
  }

  .navbar {
    position: sticky; top: 0; z-index: 100;
    padding: var(--safe-top) 16px 12px;
    background: rgba(0,0,0,0.72);
    backdrop-filter: saturate(180%) blur(20px);
    -webkit-backdrop-filter: saturate(180%) blur(20px);
    border-bottom: 0.5px solid var(--separator);
  }
  .navbar h1 { font-size: 34px; font-weight: 700; letter-spacing: -0.4px; }
  .navbar .subtitle { font-size: 15px; color: var(--text-secondary); margin-top: 2px; }
  .back-btn {
    display: none; align-items: center; gap: 4px;
    background: none; border: none; color: var(--blue);
    font-size: 17px; font-family: inherit; cursor: pointer;
    padding: 4px 0; margin-bottom: 4px;
  }
  .back-btn svg { width: 20px; height: 20px; }
  .back-btn.visible { display: flex; }

  .content {
    padding: 16px 16px calc(16px + var(--safe-bottom));
    max-width: 500px; margin: 0 auto;
  }

  .section-label {
    font-size: 13px; font-weight: 600; color: var(--text-secondary);
    text-transform: uppercase; letter-spacing: 0.02em; padding: 0 16px 8px;
  }

  /* â”€â”€ Weather widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .weather-widget {
    background: var(--bg-card); border-radius: var(--radius);
    padding: 16px; margin-bottom: 32px; cursor: pointer;
    transition: background 0.15s;
    -webkit-user-select: none; user-select: none;
  }
  .weather-widget:active { background: var(--bg-card-hover); }
  .weather-top {
    display: flex; align-items: center; justify-content: space-between;
  }
  .weather-temp-group { display: flex; align-items: baseline; gap: 6px; }
  .weather-icon { font-size: 36px; line-height: 1; }
  .weather-temp { font-size: 42px; font-weight: 300; letter-spacing: -1px; }
  .weather-desc { font-size: 15px; color: var(--text-secondary); font-weight: 500; }
  .weather-details {
    display: flex; gap: 20px; margin-top: 10px;
    font-size: 14px; color: var(--text-secondary);
  }
  .weather-details span { display: flex; align-items: center; gap: 4px; }
  .weather-loading {
    text-align: center; padding: 12px 0;
    font-size: 14px; color: var(--text-tertiary);
  }
  .weather-location {
    font-size: 13px; color: var(--text-tertiary); margin-top: 8px;
  }

  /* â”€â”€ Grouped list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .list-group {
    background: var(--bg-card); border-radius: var(--radius);
    overflow: hidden; margin-bottom: 32px;
  }
  .list-item {
    display: flex; align-items: center; gap: 14px; padding: 12px 16px;
    cursor: pointer; transition: background 0.15s;
    border-bottom: 0.5px solid var(--separator);
    text-decoration: none; color: inherit;
    -webkit-user-select: none; user-select: none;
  }
  .list-item:last-child { border-bottom: none; }
  .list-item:active { background: var(--bg-card-hover); }
  .list-item .icon {
    width: 36px; height: 36px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
  }
  .list-item .label { flex: 1; font-size: 17px; font-weight: 400; }
  .list-item .label .detail { font-size: 13px; color: var(--text-secondary); margin-top: 1px; }
  .list-item .chevron { color: var(--text-tertiary); font-size: 14px; font-weight: 600; }

  /* â”€â”€ Route picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .route-picker { padding: 8px 0; }
  .route-columns {
    display: grid; grid-template-columns: 1fr auto 1fr;
    gap: 12px; align-items: start; margin-bottom: 24px;
  }
  .route-col-label {
    font-size: 13px; font-weight: 600; color: var(--text-secondary);
    text-transform: uppercase; letter-spacing: 0.02em;
    text-align: center; margin-bottom: 10px;
  }
  .route-arrow {
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; color: var(--text-tertiary);
    padding-top: 38px;
  }
  .route-btn {
    display: flex; align-items: center; justify-content: center;
    gap: 8px; padding: 14px 12px;
    background: var(--bg-card); border: 2px solid transparent;
    border-radius: 12px; cursor: pointer;
    font-size: 16px; font-weight: 500; color: var(--text-primary);
    font-family: inherit; transition: all 0.2s;
    width: 100%; margin-bottom: 8px;
    -webkit-user-select: none; user-select: none;
  }
  .route-btn:active { background: var(--bg-card-hover); }
  .route-btn.selected { border-color: var(--blue); background: rgba(10,132,255,0.12); }
  .route-btn.disabled {
    opacity: 0.3; pointer-events: none;
  }
  .route-go-btn {
    width: 100%; padding: 16px; background: var(--blue); color: white;
    border: none; border-radius: 14px; font-size: 17px;
    font-weight: 600; font-family: inherit; cursor: pointer;
    transition: opacity 0.2s;
  }
  .route-go-btn:active { opacity: 0.8; }
  .route-go-btn:disabled { opacity: 0.3; pointer-events: none; }

  /* â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .results-section { margin-bottom: 28px; }
  .results-header {
    font-size: 15px; font-weight: 600; color: var(--text-secondary);
    padding: 0 4px 10px; display: flex; align-items: center; gap: 6px;
  }
  .results-header .badge {
    font-size: 11px; font-weight: 600; padding: 2px 7px; border-radius: 6px;
    background: rgba(255,69,58,0.15); color: var(--red);
    text-transform: uppercase; letter-spacing: 0.03em;
  }
  .results-table { background: var(--bg-card); border-radius: var(--radius); overflow: hidden; }
  .table-header {
    display: grid; grid-template-columns: 1fr 52px 52px 52px;
    padding: 10px 14px; font-size: 12px; font-weight: 600;
    color: var(--text-tertiary); text-transform: uppercase;
    letter-spacing: 0.03em; border-bottom: 0.5px solid var(--separator);
  }
  .table-header span:not(:first-child) { text-align: center; }
  .table-row {
    display: grid; grid-template-columns: 1fr 52px 52px 52px;
    padding: 13px 14px; align-items: center;
    border-bottom: 0.5px solid var(--separator); font-size: 15px;
  }
  .table-row:last-child { border-bottom: none; }
  .table-row .station-name {
    font-weight: 500; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis; padding-right: 8px;
  }
  .table-row .val {
    text-align: center; font-weight: 600;
    font-variant-numeric: tabular-nums; font-size: 16px;
  }
  .val.good { color: var(--green); }
  .val.low { color: var(--yellow); }
  .val.empty { color: var(--red); }
  .val.muted { color: var(--text-tertiary); font-weight: 400; }

  .loading-container {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; padding: 60px 0; gap: 14px;
  }
  .spinner {
    width: 28px; height: 28px;
    border: 3px solid var(--text-tertiary); border-top-color: var(--text-primary);
    border-radius: 50%; animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-size: 15px; color: var(--text-secondary); }

  .timestamp { text-align: center; font-size: 13px; color: var(--text-tertiary); padding: 16px 0 8px; }
  .legend {
    display: flex; justify-content: center; gap: 16px;
    padding: 8px 0 20px; font-size: 12px; color: var(--text-secondary);
  }
  .legend span { display: flex; align-items: center; gap: 4px; }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

  .screen { display: none; }
  .screen.active { display: block; animation: fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  .error-msg {
    text-align: center; padding: 40px 20px;
    color: var(--text-secondary); font-size: 15px; line-height: 1.5;
  }
  .error-msg .error-icon { font-size: 40px; margin-bottom: 12px; }
  .error-detail {
    font-size: 12px; color: var(--text-tertiary); word-break: break-all;
    margin-top: 12px; padding: 10px; background: var(--bg-card);
    border-radius: 8px; text-align: left;
  }
  .retry-btn {
    display: inline-flex; align-items: center; gap: 6px;
    margin-top: 20px; padding: 12px 28px;
    background: var(--bg-card); border: 1px solid var(--separator);
    border-radius: 12px; color: var(--blue); font-size: 15px;
    font-weight: 600; font-family: inherit; cursor: pointer;
    transition: opacity 0.2s;
  }
  .retry-btn:active { opacity: 0.7; }
  .retry-btn:disabled { opacity: 0.3; pointer-events: none; }
  .retry-countdown {
    font-size: 13px; color: var(--text-tertiary); margin-top: 8px;
  }
  .version-label {
    text-align: center; font-size: 12px; color: var(--text-tertiary);
    padding: 32px 0 8px;
  }

  /* â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .settings-btn {
    position: absolute; right: 16px; top: var(--safe-top);
    background: none; border: none; color: var(--blue);
    font-size: 22px; cursor: pointer; padding: 8px; line-height: 1;
  }
  .settings-field { margin-bottom: 24px; }
  .settings-input-row {
    display: flex; gap: 8px; align-items: center;
  }
  .settings-input {
    flex: 1; padding: 12px 14px; background: var(--bg-card);
    border: 1px solid var(--separator); border-radius: 10px;
    color: var(--text-primary); font-size: 15px; font-family: inherit;
    outline: none;
  }
  .settings-input:focus { border-color: var(--blue); }
  .settings-input::placeholder { color: var(--text-tertiary); }
  .settings-input:disabled { color: var(--text-tertiary); opacity: 0.7; }
  .lock-btn {
    width: 44px; height: 44px; flex-shrink: 0;
    background: var(--bg-card); border: 1px solid var(--separator);
    border-radius: 10px; font-size: 20px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }
  .lock-btn:active { background: var(--bg-card-hover); }
  .settings-note {
    font-size: 13px; color: var(--text-tertiary);
    padding: 8px 4px 0; line-height: 1.4;
  }
  .settings-note a { color: var(--blue); text-decoration: none; }
  .save-btn {
    width: 100%; padding: 14px; background: var(--blue); color: white;
    border: none; border-radius: 12px; font-size: 17px;
    font-weight: 600; font-family: inherit; cursor: pointer;
    transition: opacity 0.2s;
  }
  .save-btn:active { opacity: 0.8; }
  .save-btn:disabled { opacity: 0.3; pointer-events: none; }
</style>
</head>
<body>

<div class="navbar">
  <button class="back-btn" id="backBtn" onclick="goBack()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
    Back
  </button>
  <h1 id="navTitle">ğŸš² Bikes</h1>
  <div class="subtitle" id="navSubtitle">Santander Cycles</div>
  <button class="settings-btn" id="settingsBtn" onclick="showSettings()">âš™ï¸</button>
</div>

<div class="content">

  <!-- HOME SCREEN -->
  <div class="screen active" id="homeScreen">

    <!-- Weather widget -->
    <div class="section-label">Weather</div>
    <div class="weather-widget" id="weatherWidget" onclick="window.open('https://www.bbc.com/weather/2643743','_blank')">
      <div class="weather-loading" id="weatherLoading">Loading weatherâ€¦</div>
      <div id="weatherContent" style="display:none">
        <div class="weather-top">
          <div>
            <div class="weather-temp-group">
              <span class="weather-icon" id="wIcon"></span>
              <span class="weather-temp" id="wTemp"></span>
            </div>
            <div class="weather-desc" id="wDesc"></div>
          </div>
        </div>
        <div class="weather-details">
          <span>ğŸŒ¡ï¸ Feels <span id="wFeels"></span></span>
          <span>ğŸ’¨ <span id="wWind"></span></span>
          <span>ğŸ’§ <span id="wHumidity"></span></span>
        </div>
        <div class="weather-location">ğŸ“ Hoxton, London Â· Tap for forecast</div>
      </div>
    </div>

    <div class="section-label">Check a location</div>
    <div class="list-group">
      <div class="list-item" onclick="checkLocation('home')">
        <div class="icon" style="background:#30d15822">ğŸ </div>
        <div class="label">Home<div class="detail">Hoxton</div></div>
        <div class="chevron">â€º</div>
      </div>
      <div class="list-item" onclick="checkLocation('office')">
        <div class="icon" style="background:#0a84ff22">ğŸ¢</div>
        <div class="label">Office<div class="detail">West End</div></div>
        <div class="chevron">â€º</div>
      </div>
      <div class="list-item" onclick="checkLocation('gym')">
        <div class="icon" style="background:#ff9f0a22">ğŸ’ª</div>
        <div class="label">Gym<div class="detail">Shoreditch</div></div>
        <div class="chevron">â€º</div>
      </div>
    </div>

    <div class="section-label">Check a route</div>
    <div class="list-group">
      <div class="list-item" onclick="showRoutePicker()">
        <div class="icon" style="background:#0a84ff22">ğŸ—ºï¸</div>
        <div class="label">Plan a Route<div class="detail">Pick start & destination</div></div>
        <div class="chevron">â€º</div>
      </div>
    </div>
  </div>

  <!-- ROUTE PICKER SCREEN -->
  <div class="screen" id="routeScreen">
    <div class="route-picker">
      <div class="route-columns">
        <div>
          <div class="route-col-label">From</div>
          <button class="route-btn" data-dir="from" data-place="home" onclick="pickRoute(this)">ğŸ  Home</button>
          <button class="route-btn" data-dir="from" data-place="office" onclick="pickRoute(this)">ğŸ¢ Office</button>
          <button class="route-btn" data-dir="from" data-place="gym" onclick="pickRoute(this)">ğŸ’ª Gym</button>
        </div>
        <div class="route-arrow">â†’</div>
        <div>
          <div class="route-col-label">To</div>
          <button class="route-btn" data-dir="to" data-place="home" onclick="pickRoute(this)">ğŸ  Home</button>
          <button class="route-btn" data-dir="to" data-place="office" onclick="pickRoute(this)">ğŸ¢ Office</button>
          <button class="route-btn" data-dir="to" data-place="gym" onclick="pickRoute(this)">ğŸ’ª Gym</button>
        </div>
      </div>
      <button class="route-go-btn" id="routeGoBtn" disabled onclick="executeRoute()">Check Route</button>
    </div>
  </div>

  <!-- RESULTS SCREEN -->
  <div class="screen" id="resultsScreen">
    <div id="resultsContainer"></div>
  </div>

  <!-- SETTINGS SCREEN -->
  <div class="screen" id="settingsScreen">
    <div class="settings-field">
      <div class="section-label">TfL API Key</div>
      <div class="settings-input-row">
        <input type="text" class="settings-input" id="tflKeyInput" placeholder="Paste your TfL API key">
        <button class="lock-btn" id="tflLockBtn" onclick="toggleLock('tfl')" style="display:none">ğŸ”’</button>
      </div>
      <div class="settings-note">
        Free from <a href="https://api-portal.tfl.gov.uk/" target="_blank">api-portal.tfl.gov.uk</a> â€” raises rate limit 50 â†’ 500 req/min.
      </div>
    </div>

    <button class="save-btn" id="saveBtn" onclick="saveSettings()">Save</button>
    <div class="version-label">v1.0.0</div>
  </div>

</div>

<script>
// â”€â”€ Station config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STATIONS = {
  home:   { label: 'ğŸ  Home â€” Hoxton',       ids: { 42: 'Wenlock Road',    30: 'Windsor Terrace' }},
  office: { label: 'ğŸ¢ Office â€” West End',    ids: { 83: 'Panton Street',   325: "St. Martin's St", 226: 'Charles II St', 233: 'Pall Mall East' }},
  gym:    { label: 'ğŸ’ª Gym â€” Shoreditch',     ids: { 132: 'Bethnal Green Rd', 399: 'Brick Lane Market' }},
};
const BACKUP = {
  home:   { label: 'ğŸ  Home backup',          ids: { 63: 'Murray Grove',    351: 'Macclesfield Rd' }},
  office: { label: 'ğŸ¢ Office backup',        ids: { 160: 'Waterloo Place', 341: 'Craven Street', 64: 'William IV St', 228: "St. James's Sq" }},
  gym:    null,
};
const ALL_IDS = new Set();
for (const p of Object.values(STATIONS)) Object.keys(p.ids).forEach(id => ALL_IDS.add(id));
for (const p of Object.values(BACKUP)) { if (p) Object.keys(p.ids).forEach(id => ALL_IDS.add(id)); }

const THRESHOLDS = { bikes: 3, docks_arrive: 5, location: 5 };
const PLACE_NAMES = { home: 'Home', office: 'Office', gym: 'Gym' };
const PLACE_ICONS = { home: 'ğŸ ', office: 'ğŸ¢', gym: 'ğŸ’ª' };

// â”€â”€ Settings / API keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tflKey = '';
try { tflKey = localStorage.getItem('tfl_api_key') || ''; } catch(e) {}

// â”€â”€ Navigation stack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let navStack = ['homeScreen'];

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById('backBtn').classList.toggle('visible', id !== 'homeScreen');
  document.getElementById('settingsBtn').style.display = id === 'homeScreen' ? '' : 'none';
}

function pushScreen(id) {
  navStack.push(id);
  showScreen(id);
}

function goBack() {
  if (navStack.length > 1) navStack.pop();
  const prev = navStack[navStack.length - 1];
  showScreen(prev);
  if (prev === 'homeScreen') {
    document.getElementById('navTitle').textContent = 'ğŸš² Bikes';
    document.getElementById('navSubtitle').textContent = 'Santander Cycles';
  } else if (prev === 'routeScreen') {
    document.getElementById('navTitle').textContent = 'ğŸ—ºï¸ Plan Route';
    document.getElementById('navSubtitle').textContent = 'Pick start & destination';
  }
}

function goHome() {
  navStack = ['homeScreen'];
  document.getElementById('navTitle').textContent = 'ğŸš² Bikes';
  document.getElementById('navSubtitle').textContent = 'Santander Cycles';
  showScreen('homeScreen');
}

// â”€â”€ Weather (Open-Meteo, no key needed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WMO_CODES = {
  0: ['â˜€ï¸','Clear sky'], 1: ['ğŸŒ¤ï¸','Mainly clear'], 2: ['â›…','Partly cloudy'], 3: ['â˜ï¸','Overcast'],
  45: ['ğŸŒ«ï¸','Fog'], 48: ['ğŸŒ«ï¸','Rime fog'],
  51: ['ğŸŒ¦ï¸','Light drizzle'], 53: ['ğŸŒ¦ï¸','Drizzle'], 55: ['ğŸŒ§ï¸','Heavy drizzle'],
  61: ['ğŸŒ§ï¸','Light rain'], 63: ['ğŸŒ§ï¸','Rain'], 65: ['ğŸŒ§ï¸','Heavy rain'],
  66: ['ğŸŒ§ï¸','Freezing rain'], 67: ['ğŸŒ§ï¸','Heavy freezing rain'],
  71: ['ğŸŒ¨ï¸','Light snow'], 73: ['ğŸŒ¨ï¸','Snow'], 75: ['ğŸŒ¨ï¸','Heavy snow'],
  77: ['ğŸŒ¨ï¸','Snow grains'],
  80: ['ğŸŒ¦ï¸','Light showers'], 81: ['ğŸŒ§ï¸','Showers'], 82: ['ğŸŒ§ï¸','Heavy showers'],
  85: ['ğŸŒ¨ï¸','Snow showers'], 86: ['ğŸŒ¨ï¸','Heavy snow showers'],
  95: ['â›ˆï¸','Thunderstorm'], 96: ['â›ˆï¸','Thunderstorm + hail'], 99: ['â›ˆï¸','Severe thunderstorm'],
};

async function loadWeather() {
  try {
    // Hoxton coordinates
    const url = 'https://api.open-meteo.com/v1/forecast?latitude=51.531&longitude=-0.083&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&wind_speed_unit=mph&timezone=Europe%2FLondon';
    const r = await fetch(url);
    const d = await r.json();
    const c = d.current;
    const [icon, desc] = WMO_CODES[c.weather_code] || ['ğŸŒ¡ï¸', 'Unknown'];

    document.getElementById('wIcon').textContent = icon;
    document.getElementById('wTemp').textContent = `${Math.round(c.temperature_2m)}Â°`;
    document.getElementById('wDesc').textContent = desc;
    document.getElementById('wFeels').textContent = `${Math.round(c.apparent_temperature)}Â°`;
    document.getElementById('wWind').textContent = `${Math.round(c.wind_speed_10m)} mph`;
    document.getElementById('wHumidity').textContent = `${c.relative_humidity_2m}%`;

    document.getElementById('weatherLoading').style.display = 'none';
    document.getElementById('weatherContent').style.display = 'block';
  } catch(e) {
    document.getElementById('weatherLoading').textContent = 'Weather unavailable';
  }
}

// â”€â”€ Bike API (single bulk fetch, 30s cache) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _cache = { data: null, ts: 0 };

async function fetchAllStations() {
  const now = Date.now();
  if (_cache.data && (now - _cache.ts) < 30000) return _cache.data;

  const keyParam = tflKey ? `?app_key=${encodeURIComponent(tflKey)}` : '';
  const r = await fetch(`https://api.tfl.gov.uk/BikePoint${keyParam}`, {
    mode: 'cors', cache: 'no-store', headers: { 'Accept': 'application/json' },
  });
  if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);

  const allData = await r.json();
  const indexed = {};
  for (const station of allData) {
    const id = station.id.split('_')[1];
    if (!ALL_IDS.has(id)) continue;
    const get = k => {
      const p = station.additionalProperties?.find(x => x.key === k);
      return p ? parseInt(p.value, 10) || 0 : 0;
    };
    indexed[id] = { bikes: get('NbStandardBikes'), ebikes: get('NbEBikes'), empty: get('NbEmptyDocks'), total: get('NbDocks') };
  }
  _cache = { data: indexed, ts: now };
  return indexed;
}

function getGroup(all, ids) {
  return Object.entries(ids).map(([id, name]) => ({ id, name, data: all[id] || null }));
}

// â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function colorClass(v, t) { return v === 0 ? 'empty' : v <= t ? 'low' : 'good'; }

function renderTable(stations, label, bt, dt, isBackup) {
  const badge = isBackup ? ' <span class="badge">backup</span>' : '';
  let h = `<div class="results-section"><div class="results-header">${label}${badge}</div>
    <div class="results-table"><div class="table-header">
      <span>Station</span><span>ğŸš²</span><span>âš¡</span><span>ğŸ“</span></div>`;
  for (const s of stations) {
    if (!s.data) {
      h += `<div class="table-row"><div class="station-name">${s.name}</div><div class="val muted">â€”</div><div class="val muted">â€”</div><div class="val muted">â€”</div></div>`;
    } else {
      h += `<div class="table-row"><div class="station-name">${s.name}</div>
        <div class="val ${colorClass(s.data.bikes, bt)}">${s.data.bikes}</div>
        <div class="val muted">${s.data.ebikes}</div>
        <div class="val ${colorClass(s.data.empty, dt)}">${s.data.empty}</div></div>`;
    }
  }
  return h + '</div></div>';
}

function needsBackup(stations, bt, dt) {
  return stations.some(s => !s.data || (bt < 900 && s.data.bikes <= bt) || (dt < 900 && s.data.empty <= dt));
}

function renderFooter() {
  const n = new Date();
  return `<div class="legend">
    <span><span class="legend-dot" style="background:var(--green)"></span> Good</span>
    <span><span class="legend-dot" style="background:var(--yellow)"></span> Low</span>
    <span><span class="legend-dot" style="background:var(--red)"></span> Empty</span></div>
    <div class="timestamp">Updated ${n.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})} Â· ${n.toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'numeric'})}</div>
    <div class="timestamp" style="padding-top:2px">ğŸš² bikes Â· âš¡ e-bikes Â· ğŸ“ empty docks</div>`;
}

function showLoading() {
  return '<div class="loading-container"><div class="spinner"></div><div class="loading-text">Checking stationsâ€¦</div></div>';
}

function showError(detail) {
  let hint = '';
  if (detail && (detail.includes('429') || detail.includes('Too Many') || detail.includes('rate')))
    hint = '<br><br>Rate limited â€” wait a minute, or add a free API key in âš™ï¸ settings.';
  const extra = detail ? `<div class="error-detail">${detail}</div>` : '';
  return `<div class="error-msg"><div class="error-icon">ğŸ“¡</div>Couldn't reach the TfL API.${hint}${extra}
    <button class="retry-btn" id="retryBtn" onclick="retryFetch()">â†» Retry</button>
    <div class="retry-countdown" id="retryCountdown"></div></div>`;
}

// â”€â”€ Retry with progressive backoff â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _retryCount = 0;
let _retryTimer = null;
let _lastAction = null; // stores { fn, args } for retry

function setLastAction(fn, args) {
  _lastAction = { fn, args };
  _retryCount = 0; // reset backoff on new user action
}

function retryFetch() {
  if (!_lastAction) return;
  const delays = [5, 10, 15, 15]; // progressive backoff in seconds
  const delay = delays[Math.min(_retryCount, delays.length - 1)];
  _retryCount++;

  const btn = document.getElementById('retryBtn');
  const countdown = document.getElementById('retryCountdown');
  if (btn) btn.disabled = true;

  let remaining = delay;
  countdown.textContent = `Retrying in ${remaining}sâ€¦`;

  clearInterval(_retryTimer);
  _retryTimer = setInterval(() => {
    remaining--;
    if (remaining <= 0) {
      clearInterval(_retryTimer);
      _cache = { data: null, ts: 0 }; // clear cache before retry
      _lastAction.fn(..._lastAction.args);
    } else {
      countdown.textContent = `Retrying in ${remaining}sâ€¦`;
    }
  }, 1000);
}

// â”€â”€ Location check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkLocation(place) {
  setLastAction(checkLocation, [place]);
  document.getElementById('navTitle').textContent = `${PLACE_ICONS[place]} ${PLACE_NAMES[place]}`;
  document.getElementById('navSubtitle').textContent = '';
  pushScreen('resultsScreen');
  const c = document.getElementById('resultsContainer');
  c.innerHTML = showLoading();
  try {
    const all = await fetchAllStations();
    const st = getGroup(all, STATIONS[place].ids);
    if (st.every(s => !s.data)) { c.innerHTML = showError('No data for these stations'); return; }
    const t = THRESHOLDS.location;
    let h = renderTable(st, STATIONS[place].label, t, t, false);
    if (needsBackup(st, t, t) && BACKUP[place])
      h += renderTable(getGroup(all, BACKUP[place].ids), BACKUP[place].label, t, t, true);
    c.innerHTML = h + renderFooter();
  } catch(e) { c.innerHTML = showError(e.message); }
}

// â”€â”€ Route picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let routeFrom = null, routeTo = null;

function showRoutePicker() {
  routeFrom = null; routeTo = null;
  document.getElementById('navTitle').textContent = 'ğŸ—ºï¸ Plan Route';
  document.getElementById('navSubtitle').textContent = 'Pick start & destination';
  updateRouteUI();
  pushScreen('routeScreen');
}

function pickRoute(btn) {
  const dir = btn.dataset.dir;
  const place = btn.dataset.place;

  if (dir === 'from') routeFrom = (routeFrom === place) ? null : place;
  else routeTo = (routeTo === place) ? null : place;

  // Prevent same origin and destination
  if (routeFrom && routeTo && routeFrom === routeTo) {
    if (dir === 'from') routeTo = null;
    else routeFrom = null;
  }

  updateRouteUI();
}

function updateRouteUI() {
  document.querySelectorAll('.route-btn').forEach(btn => {
    const dir = btn.dataset.dir;
    const place = btn.dataset.place;
    const selected = (dir === 'from' && routeFrom === place) || (dir === 'to' && routeTo === place);
    const otherSelected = (dir === 'from' && routeTo === place) || (dir === 'to' && routeFrom === place);
    btn.classList.toggle('selected', selected);
    btn.classList.toggle('disabled', otherSelected);
  });
  document.getElementById('routeGoBtn').disabled = !(routeFrom && routeTo);
}

async function executeRoute() {
  if (!routeFrom || !routeTo) return;
  setLastAction(executeRoute, []);
  document.getElementById('navTitle').textContent = `${PLACE_ICONS[routeFrom]} â†’ ${PLACE_ICONS[routeTo]}`;
  document.getElementById('navSubtitle').textContent = `${PLACE_NAMES[routeFrom]} to ${PLACE_NAMES[routeTo]}`;
  pushScreen('resultsScreen');
  const c = document.getElementById('resultsContainer');
  c.innerHTML = showLoading();
  try {
    const all = await fetchAllStations();
    const fs = getGroup(all, STATIONS[routeFrom].ids);
    const ts = getGroup(all, STATIONS[routeTo].ids);
    if (fs.every(s => !s.data) && ts.every(s => !s.data)) { c.innerHTML = showError('No data for these stations'); return; }
    const bt = THRESHOLDS.bikes, dt = THRESHOLDS.docks_arrive;
    let h = renderTable(fs, `${STATIONS[routeFrom].label} Â· picking up`, bt, 999, false);
    h += renderTable(ts, `${STATIONS[routeTo].label} Â· dropping off`, 999, dt, false);
    if (needsBackup(fs, bt, 999) && BACKUP[routeFrom])
      h += renderTable(getGroup(all, BACKUP[routeFrom].ids), `${BACKUP[routeFrom].label} Â· pick up`, bt, 999, true);
    if (needsBackup(ts, 999, dt) && BACKUP[routeTo])
      h += renderTable(getGroup(all, BACKUP[routeTo].ids), `${BACKUP[routeTo].label} Â· drop off`, 999, dt, true);
    c.innerHTML = h + renderFooter();
  } catch(e) { c.innerHTML = showError(e.message); }
}

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tflLocked = true;

function showSettings() {
  document.getElementById('navTitle').textContent = 'âš™ï¸ Settings';
  document.getElementById('navSubtitle').textContent = '';
  tflLocked = !!tflKey;
  renderSettingsUI();
  pushScreen('settingsScreen');
}

function renderSettingsUI() {
  const input = document.getElementById('tflKeyInput');
  const lockBtn = document.getElementById('tflLockBtn');
  const saveBtn = document.getElementById('saveBtn');

  if (tflKey && tflLocked) {
    // Show masked key, locked
    input.value = 'â€¢'.repeat(Math.min(tflKey.length, 32));
    input.disabled = true;
    lockBtn.style.display = 'flex';
    lockBtn.textContent = 'ğŸ”’';
    saveBtn.disabled = true;
  } else {
    // Editable
    input.value = tflKey;
    input.disabled = false;
    lockBtn.style.display = tflKey ? 'flex' : 'none';
    lockBtn.textContent = 'ğŸ”“';
    saveBtn.disabled = false;
    if (!tflKey) lockBtn.style.display = 'none';
  }
}

function toggleLock(type) {
  if (type === 'tfl') {
    tflLocked = !tflLocked;
    renderSettingsUI();
    if (!tflLocked) {
      document.getElementById('tflKeyInput').focus();
    }
  }
}

function saveSettings() {
  const newKey = document.getElementById('tflKeyInput').value.trim();
  tflKey = newKey;
  try { localStorage.setItem('tfl_api_key', tflKey); } catch(e) {}
  _cache = { data: null, ts: 0 };
  tflLocked = !!tflKey;
  renderSettingsUI();
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadWeather();
</script>
</body>
</html>
